<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn - Flashlite</title>

    <!-- Load static files library -->
    {% load static %}

    <!-- Link to the external styles.css file -->
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <style>
        /* Body styles */
        body {
            font-family: 'Varela Round', sans-serif;
            margin: 0;
            height: 100vh; /* Take full height of the viewport */
            display: flex;
            justify-content: center; /* Horizontally center */
            align-items: center; /* Vertically center */
            background-color: white; /* Set body background to white */
        }

        /* Flashcard container */
        .flashcard-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: 20px;
            width: 600px;
            padding: 20px;
            position: relative; /* Needed for positioning the close button */
        }

        /* Close button styles */
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 30px;
            color: red;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover {
            color: darkred; /* Change color when hovered */
        }

        /* Container for the boxes with numbers */
        .number-box-container {
            display: flex;
            justify-content: center;
            gap: 10px; /* Space between boxes */
            margin-bottom: 20px; /* Space between boxes and the flashcard */
        }

        /* Style for each small box */
        .number-box {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f4f4f4;
            border: 2px solid #00A682;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: black;
            transition: transform 0.2s; /* Smooth scaling */
        }

        /* Hover effect for the boxes */
        .number-box:hover {
            background-color: #00A682;
            color: white;
        }

        /* Style for the selected box */
        .selected-box {
            transform: scale(1.3); /* Slightly bigger */
            background-color: #00A682; /* Change the background color */
            color: white; /* Change text color to white */
        }

        /* Flashcard styles */
        .flashcard {
            width: 100%;
            height: 300px;
            border: 12px solid #84F3DA;
            text-align: center;
            line-height: normal;
            background-color: #f4f4f4;
            color: #333;
            border-radius: 20px;
            padding: 15px;
        }

        .flashcard {
            user-select: none; /* Standard */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
        }

        .flashcard-text {
            font-size: 24px;
            text-align: center;
        }

        /* Styling for arrow buttons */
        .arrow-button {
            background-color: transparent;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #00A682;
        }

        .arrow-button:hover {
            color: #008B5C;
        }

        /* Flashcard navigation container with arrows */
        .flashcard-navigation {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        /* Quiz mode styles */
        .quiz-mode {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .quiz-mode input {
            font-size: 18px;
            padding: 10px;
            width: 250px;
            margin-bottom: 20px;
        }

        .quiz-mode button {
            padding: 10px 20px;
            background-color: #00A682;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .quiz-mode button:hover {
            background-color: #008B5C;
        }

        .result {
            font-size: 20px;
            margin-top: 20px;
        }

        /* Complete message */
        .complete {
            font-size: 24px;
            color: green;
            margin-top: 20px;
        }

        /* New completion screen styles */
        .completion-screen {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 20px;
            width: 600px;
        }

        .completion-message {
            font-size: 20px;
            color: #333;
        }

        .completion-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .completion-button {
            padding: 10px 20px;
            background-color: #00A682;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }

        .completion-button:hover {
            background-color: #008B5C;
        }

    </style>
</head>
<body>
    <div class="flashcard-display">
        {% if error %}
            <p class="error-message">{{ error }}</p>
        {% endif %}
        <!-- Red X button to navigate to home page -->
        <a href="{% url 'home' %}" class="close-button">&times;</a>

        <!-- Numbered boxes for selecting flashcards -->
        <div class="number-box-container">
            <div class="number-box" data-index="0">1</div>
            <div class="number-box" data-index="1">2</div>
            <div class="number-box" data-index="2">3</div>
            <div class="number-box" data-index="3">4</div>
            <div class="number-box" data-index="4">5</div>
        </div>

        <!-- Flashcard navigation with left and right arrows -->
        <div class="flashcard-navigation">
            <button class="arrow-button" id="previous-arrow">&#8592;</button> <!-- Left arrow -->
            
            <div class="flashcard patrick-hand-regular" id="flashcard">
                {% if flashcards %}
                    <p id="card-content" class="flashcard-text">{{ flashcards.0.question }}</p>
                {% else %}
                    <p class="flashcard-text">No flashcards available.</p>
                {% endif %}
            </div>
            
            <button class="arrow-button" id="next-arrow">&#8594;</button> <!-- Right arrow -->
        </div>
    </div>

    <!-- Quiz mode container -->
    <div id="quiz-mode" class="quiz-mode">
        <input type="text" id="answer-input" placeholder="Type your answer here...">
        <button id="submit-answer-mode">Submit</button> <!-- Updated ID -->
        <div id="result-mode" class="result"></div> <!-- Updated ID -->
    </div>

    <div id="quiz-container" class="quiz-container">
        <p id="quiz-question">Loading question...</p>
        <input type="text" id="quiz-answer" placeholder="Your answer">
        <button id="submit-answer-quiz">Submit</button> <!-- Updated ID -->
        <p id="quiz-feedback-quiz"></p> <!-- Updated ID -->
    </div>

    <!-- New Completion Screen -->
    <div id="completion-screen" class="completion-screen" style="display:none;">
        <p class="completion-message">Good job! The items you have just finished quizzing on have been moved to your study queue. What would you like to do now?</p>
        <div class="completion-buttons">
            <button class="completion-button" onclick="window.location.href='{% url 'home' %}'">Return to Home Page</button>
            <button class="completion-button" onclick="window.location.reload()">Keep Going</button>
        </div>
    </div>

    <!-- JavaScript to handle flashcard display, number box clicks, and quiz mode -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        // Filter flashcards to only include those with is_learned = false
        let flashcards = [
            {% for flashcard in flashcards %}
                { 
                    card_id: {{ flashcard.card_id }},
                    question: "{{ flashcard.question|escapejs }}", 
                    answer: "{{ flashcard.answer|escapejs }}",
                    is_learned: {{ flashcard.is_learned|yesno:"true,false" }} // Store is_learned status
                },
            {% endfor %}
        ].filter(flashcard => !flashcard.is_learned); // Only include flashcards that are not learned
    
        // Limit to a maximum of 5 flashcards
        flashcards = flashcards.slice(0, 5); // Take only the first 5 cards (you can also randomize here if needed)
        
        let currentIndex = 0;
        let answeredQuestions = 0; // To track answered questions
        let totalQuestions = flashcards.length;
        let showingQuestion = true; // Track whether the question or answer is displayed
        let isQuizMode = false;  // Flag to track quiz mode state
        let remainingQuestions = Array.from({ length: flashcards.length }, (_, i) => i);  // List of indices for unanswered questions
        let cardContent = document.getElementById("card-content");
        let flashcardElement = document.getElementById("flashcard");

        // Function declarations for flashcard logic
        function updateNumberBoxes() {
            const numberBoxContainer = document.querySelector('.number-box-container');
            numberBoxContainer.innerHTML = ''; // Clear existing number boxes
    
            // Create new number boxes for the remaining flashcards
            flashcards.forEach((_, index) => {
                const numberBox = document.createElement('div');
                numberBox.classList.add('number-box');
                numberBox.setAttribute('data-index', index);
                numberBox.innerText = index + 1;
                numberBoxContainer.appendChild(numberBox);
    
                // Add event listener to number box
                numberBox.addEventListener('click', function () {
                    currentIndex = index;
                    showingQuestion = true;
                    updateCardContent();
                });
            });
    
            // Highlight the selected box
            updateNumberBox();
        }
    
        function updateCardContent() {
            if (flashcards.length > 0) {
                cardContent.innerText = showingQuestion ? flashcards[currentIndex].question : flashcards[currentIndex].answer;
                updateNumberBox(); // Highlight box
            }
        }
    
        function updateNumberBox() {
            document.querySelectorAll('.number-box').forEach(box => box.classList.remove('selected-box'));
            const selectedBox = document.querySelectorAll('.number-box')[currentIndex];
            selectedBox.classList.add('selected-box');
        }

        // Fetch a new question for Quiz Mode
        function fetchQuestion() {
            fetch("/quiz-question/")
                .then(response => response.json())
                .then(data => {
                    const questionElement = document.getElementById("quiz-question");
                    const answerInput = document.getElementById("quiz-answer");
                    const feedbackElement = document.getElementById("quiz-feedback");

                    questionElement.textContent = data.question;
                    questionElement.setAttribute("data-flashcard-id", data.flashcard_id);
                    feedbackElement.textContent = "";
                    answerInput.value = "";
                });
        }

        // Initialize flashcard logic
        updateCardContent();
        updateNumberBoxes();

        // Event listeners for flashcard interaction
        document.getElementById("previous-arrow").addEventListener("click", function () {
            currentIndex = (currentIndex - 1 + flashcards.length) % flashcards.length;
            showingQuestion = true;
            updateCardContent();
        });

        document.getElementById("next-arrow").addEventListener("click", function () {
            if (currentIndex === flashcards.length - 1) {
                document.getElementById("quiz-mode").style.display = 'flex'; // Show quiz mode
                isQuizMode = true; // Set quiz mode flag
                fetchQuestion(); // Fetch the first question
            } else {
                currentIndex = (currentIndex + 1) % flashcards.length;
                showingQuestion = true;
                updateCardContent();
            }
        });

        // Handle quiz question validation
        const submitButton = document.getElementById("submit-answer");
        submitButton.addEventListener("click", function () {
            const questionElement = document.getElementById("quiz-question");
            const answerInput = document.getElementById("quiz-answer");
            const feedbackElement = document.getElementById("quiz-feedback");

            const userAnswer = answerInput.value.trim();
            const flashcardId = questionElement.getAttribute("data-flashcard-id");

            fetch("/validate-answer/", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ answer: userAnswer, flashcard_id: flashcardId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.correct) {
                        feedbackElement.textContent = "Correct!";
                        feedbackElement.style.color = "green";
                    } else {
                        feedbackElement.textContent = `Incorrect! The correct answer is: ${data.correct_answer}`;
                        feedbackElement.style.color = "red";
                    }
                    setTimeout(fetchQuestion, 2000); // Fetch a new question after 2 seconds
                });
        });
    });
                
    </script>
            
    
</body>
</html>
