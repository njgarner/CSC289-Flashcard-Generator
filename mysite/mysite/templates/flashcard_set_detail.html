<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ flashcard_set.title }} - Details</title>
    <script>
        // Function to calculate time until next review
        function timeUntilNextReview(nextReviewDate) {
            const reviewDate = new Date(nextReviewDate);
            const now = new Date();
            const diff = reviewDate - now; // Difference in milliseconds

            // If the review date is in the past, show the difference in minutes, hours, or days
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            const remainingMinutes = minutes % 60;
            const remainingHours = hours % 24;

            let timeString = '';

            if (days > 0) timeString += days + " day" + (days > 1 ? 's' : '') + " ";
            if (remainingHours > 0) timeString += remainingHours + " hour" + (remainingHours > 1 ? 's' : '') + " ";
            if (remainingMinutes > 0) timeString += remainingMinutes + " minute" + (remainingMinutes > 1 ? 's' : '');

            if (diff <= 0) {
                timeString = `-${Math.abs(minutes)} minutes`; // If review is overdue, show how many minutes ago
            }

            return timeString || "Less than a minute";  // For cases with less than a minute difference
        }
    </script>
</head>
<body>
    <h1>{{ flashcard_set.title }}</h1>
    <p>{{ flashcard_set.description }}</p>
    <p>Category: {{ flashcard_set.category.name }}</p>
    <p>Created on: {{ flashcard_set.created_at }}</p>
    <p>Shared: {% if flashcard_set.is_shared %} Yes {% else %} No {% endif %}</p>

    <h2>Flashcards in this Set:</h2>
    <ul>
        {% for flashcard in flashcards %}
            <li>
                <strong>Question:</strong> {{ flashcard.question }}<br>
                <strong>Answer:</strong> {{ flashcard.answer }}<br>

                {% if flashcard.is_learned %}
                    <strong>Time Until Next Review:</strong> 
                    <span class="time-until-next-review" data-review-date="{{ flashcard.next_review_date|date:'c' }}">
                        <!-- Time will be calculated and displayed here by JavaScript -->
                    </span><br>

                    <!-- Debugging: Display raw review date and calculated time -->
                    <strong>Next Review Date:</strong> {{ flashcard.next_review_date|date:'Y-m-d H:i:s' }}<br>
                    <strong>Calculated Time:</strong> <span class="calculated-time">{{ flashcard.next_review_date|date:'Y-m-d H:i:s' }}</span><br>
                {% else %}
                    <strong>Not yet learned</strong><br>
                {% endif %}

                <!-- Delete flashcard form -->
                <form action="{% url 'delete_flashcard' flashcard.card_id %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Delete</button>
                </form>
                <br>
            </li>
        {% empty %}
            <p>No flashcards available in this set.</p>
        {% endfor %}
    </ul>

    <a href="{% url 'library_view' %}">Back to Library</a>

    <script>
        // This script calculates and updates the time until next review for each flashcard.
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.time-until-next-review').forEach(element => {
                const reviewDate = element.getAttribute('data-review-date');
                const timeRemaining = timeUntilNextReview(reviewDate);
                element.textContent = timeRemaining;

                // Debugging: Log calculated times for each flashcard to the console
                console.log(`Flashcard review: ${reviewDate} -> ${timeRemaining}`);
            });

            // Debugging: Log calculated times for each flashcard
            document.querySelectorAll('.calculated-time').forEach(element => {
                const reviewDate = element.textContent;
                console.log("Calculated time for next review:", reviewDate, "->", timeUntilNextReview(reviewDate));
            });
        });
    </script>
</body>
</html>
